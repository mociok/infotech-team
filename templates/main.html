{% load static %}
<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>szybka strona ux ui</title>
    <link rel="stylesheet" href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/bootstrap/css/main_style.css' %}">

    <!-- Messages CSS -->
    <link rel="stylesheet" href="{% static 'assets/bootstrap/css/messages.css' %}">
</head>

<body style="overflow-x: hidden;">
    <!-- Messages -->
    {% if messages %}
        <div id="messages">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
    {% endif %}
    <div class="row" style="position: sticky; top: 0; z-index: 100;background-color: white">
    <!-- Lewy div -->
    <div class="col-4 d-flex justify-content-start align-items-center">
        <div class="lewy">
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" aria-expanded="false" data-bs-toggle="dropdown" id="dropdown_button" type="button" disabled>device </button>
                <div class="dropdown-menu" id="dropdown"></div>
            </div>
        </div>
    </div>

    <!-- Środkowy div -->
    <div class="col-4 d-flex justify-content-center align-items-center" style="position: sticky; top: 0; z-index: 100; background-color: white">
        <div class="srodek">
            <h1>Collabothon</h1>
        </div>
    </div>

    <!-- Prawy div -->
    <div class="col-4 d-flex justify-content-end align-items-center">
        <div class="prawo" style="">
            <a href="{% url 'logout' %}"><button class="btn btn-primary" type="button">Wyloguj</button></a>
        </div>
    </div>
</div>



    <div class="container justify-content-center align-items-center d-flex">
        <div class="row obramowka3 kontener">
          <div class="col" style="padding: 0">
            <div class="biur">
              <img src="{% static 'img/img1.png' %}" alt="zdjęcie" style="border-radius: 10px">
                <div class="blur-container">
                  <div class="blur">
                    <h4 id="ai_trend">Loading AI...</h4>
                  </div>

                  <div class="row d-flex justify-content-start align-items-start justify-content-md-center align-items-md-center blur" style="overflow-x: hidden;">
                        <div class="col d-md-flex justify-content-md-start align-items-md-center">
                            <div class="d-flex d-md-flex justify-content-start align-items-end justify-content-md-start align-items-md-center dane1">
                                <p id="data_avg">Loading...</p>
                            </div>
                        </div>
                        <div class="col d-md-flex justify-content-md-end align-items-md-center">
                            <div class="d-flex d-md-flex justify-content-start align-items-end justify-content-md-end align-items-md-center dane2">
                                <p id="data_peak">Loading...</p>
                            </div>
                        </div>
                  </div>


                   <div class="row blur" style="margin-top: 0;">
                        <div class="col obramowka2">
                            <div class="d-flex d-lg-flex justify-content-center align-items-center justify-content-lg-center align-items-lg-start">
                                <p style="font-size: 1.25rem;text-align: left;" id="carbon">Loading...</p>
                            </div>
                            <div class="d-flex justify-content-md-center align-items-md-center align-items-lg-center" style="height: 200px;min-height: 100px;">
                                <div id="bad_circle" class="d-flex d-md-flex justify-content-start align-items-start justify-content-md-center align-items-md-center" style="width: 150px;height: 150px;background: var(--bs-danger-text-emphasis);border-radius: 100px;min-width: 75px;min-height: 75px;"></div>
                                <div id="good_circle" class="d-flex d-md-flex justify-content-end align-items-end justify-content-md-center align-items-md-center" style="width: 150px;height: 150px;background: var(--bs-teal);border-radius: 100px;margin-left: 40px;"></div>
                            </div>
                        </div>
                        <div class="col obramowka2 ">
                            <div>
                                <div style="width: 100%;height: 300px;min-width: auto;">
                                    <h2>
                                        legenda rzeczy
                                    </h2>
                                    <ul style="font-size: 1.25rem">
                                        <li>uno</li>
                                        <li>uno</li>
                                        <li>uno</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                   </div>



                                    <div class="row obramowka blur" style="margin-top: 15px;">
                        <div class="col">
                            <h1>kroki postępowanie karne&nbsp;</h1><br>
                            <!--<ul style="font-size: 1.25rem">
                                <li>li</li>
                                <li>li</li>
                                <li>li</li>
                                <li>li</li>
                                <li>li</li>


                            </ul>-->
                            <p id="ai_steps"></p>
                        </div>
                    </div>
                </div>

            </div>
          </div>
        </div>
    </div>



    <script src="{% static 'assets/bootstrap/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script>
        function set_active(name) {
            var item = $(".dropdown-item").filter(function() {
                    return $(this).text().trim() === name;
                });
                if (item.length > 0) {
                    $(".dropdown-item").removeClass("active");
                    item.addClass("active");
                }
        }

        function findDeviceByName(devName) {
            return data.find(item => item.device__devName === devName);
        }

        function setText(devName, data_avg, data_peak, data_percentage) {
            //$('#1_h').html(`${devName} - carbon footprint` + `<br>Avg: ${data_avg} ppm <br> Peak: ${data_peak} ppm`)
            $('#data_avg').html("&nbsp;Data Average: " + data_avg +" ppm")
            $('#data_peak').html("Data Peak: " + data_peak +" ppm&nbsp;")

            if (data_percentage === null) {
                 $('#carbon').html(`The carbon footprint at the Sensor ${devName} has not enough data
                <br>to show the percentage change in the last hour`)
            } else {
                if (data_percentage < 0.0) {
                    $('#carbon').html(`The carbon footprint at the Sensor ${devName} has <br><c style="color:limegreen;">decreased</c>
                    by ${data_percentage * -1}% in the last hour`)
                    $('#bad_circle').css('background-color', 'var(--bs-danger-text-emphasis)')
                    $('#bad_circle').css('opacity', '0.33')
                    $('#good_circle').css('background-color', 'var(--bs-teal)')
                    $('#good_circle').css('opacity', '1')
                } else {
                    $('#carbon').html(`The carbon footprint at the Sensor ${devName} has <br><c style="color:red;">increased</c>
                    by ${data_percentage}% in the last hour`)
                    $('#bad_circle').css('background-color', 'var(--bs-red)')
                    $('#bad_circle').css('opacity', '1')
                    $('#good_circle').css('background-color', '#189a73')
                    $('#good_circle').css('opacity', '0.33')
                }
            }
        }

        let data_jsons = []
        let active_device = null
        let avg_jsons = []
        let peak_jsons = []
        let percentage_jsons = []
        let active_avg = null
        let active_peak = null
        let active_percentage = null
        $.getJSON('{% url 'get_devices' %}',function(data){
            $.each(data.devices,function(key,value){
                var data_avg = data.avg.find(element => element.device__devName === value.devName);
                var data_peak = data.peak.find(element => element.device__devName === value.devName);
                var data_percentage = data.percentage.find(element => element.devName === value.devName);
                if (data_percentage === undefined) {
                    data_percentage = {prcnt: null}
                }
                if (data_avg === undefined) {
                    data_avg = {avg_value: "No data"}
                }
                if (data_peak === undefined) {
                    data_peak = {max_value: "No data"}
                }

                if (active_device === null) {
                    active_device = value;
                    avg_jsons = data.avg
                    peak_jsons = data.peak
                    percentage_jsons = data.percentage

                    setText(active_device.devName, data_avg.avg_value, data_peak.max_value, data_percentage.prcnt)
                    $('#dropdown_button').text(value.devName)
                    $('#dropdown_button').removeAttr('disabled')

                    $('#dropdown').append('<a class="dropdown-item" href="#">'+value.devName+'</a>')
                    set_active(active_device.devName)
                    data_jsons.push(value)

                    $('#data_avg').html("&nbsp;Data Average: " + data_avg.avg_value +" ppm")
                    $('#data_peak').html("Data Peak: " + data_peak.max_value+" ppm&nbsp;")

                    GenerateText(data_avg.avg_value, data_peak.max_value, $('#carbon').text())
                } else {
                    $('#dropdown').append('<a class="dropdown-item" href="#">' + value.devName + '</a>')
                    data_jsons.push(value)
                }
            })
        }).fail(function(jqXHR, textStatus, errorThrown) {
            if (errorThrown.includes("Forbidden")) {
                alert("You are not logged in!")
                window.location.href = "{% url 'login' %}" //login
            } else {
                alert("Error: " + errorThrown + "\nTry again later!")
                window.location.href = "{% url 'login' %}" //login
            }
        })/*.done(function(){
            //Coś możemy zrobić jak sie dane załadują
        })*/
        addEventListener('click',function(e){
            if (e.target.classList.contains('dropdown-item') && !is_generating) {
                $('#dropdown_button').text(e.target.innerText)
                $('#ai_trend').text("Loading AI...")
                $('#ai_steps').text("Loading AI...")

                active_device = data_jsons.find(x => x.devName === e.target.innerText)
                set_active(active_device.devName)

                active_avg = avg_jsons.find(x => x.device__devName === active_device.devName)
                active_peak = peak_jsons.find(x => x.device__devName === active_device.devName)
                active_percentage = percentage_jsons.find(x => x.devName === active_device.devName)

                GenerateText(active_avg.avg_value, active_peak.max_value, $('#carbon').text())
                if (active_percentage === undefined) {
                    setText(active_device.devName, active_avg.avg_value, active_peak.max_value, null)
                } else
                    setText(active_device.devName, active_avg.avg_value, active_peak.max_value, active_percentage.prcnt)
            }
        })

        let is_generating = false
        function GenerateText(avg,peak, percentage) {
            if (is_generating) {
                return console.log("is generating")
            }

            $('#dropdown_button').prop('disabled', true)
            is_generating = true
            let ai_data = `{"avg": ${avg},"peak": ${peak},"percentage": ${percentage}}`
            console.log(ai_data)
            $.getJSON(`/api/ai/${ai_data}/`,
            function(data){
                console.log(data)
                $('#ai_trend').html(data.trend)
                $('#ai_steps').html(data.steps)
                $('#dropdown_button').removeAttr('disabled')
                is_generating = false
            }).fail(function(jqXHR, textStatus, errorThrown) {
                if (errorThrown.includes("Forbidden")) {
                    alert("You are not logged in!")
                    window.location.href = "{% url 'login' %}" //login
                } else {
                    console.log("Error: " + errorThrown + "\nTry again later!")
                    $('#ai_trend').text("There was an Error when generating prompt!\n Try again later")
                    $('#ai_steps').text("There was an Error when generating prompt!\n Try again later")
                    $('#dropdown_button').removeAttr('disabled')
                    is_generating = false
                }

            })
        }

    </script>
    <script>
        window.setTimeout(function() {
            $(".alert").fadeTo(500, 0).slideUp(500, function(){
                $(this).remove();
            });
        }, 4000);
    </script>
</body>

</html>